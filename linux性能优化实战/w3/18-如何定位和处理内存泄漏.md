## 18 | 案例篇：内存泄漏了，我该如何定位和处理？

### 内存的分配和回收

用户空间内存分为只读段，数据段，堆，栈以及文件映射段

栈内存：由系统自动分配和管理，一旦程序运行超出了这个拒不变量的作用域，栈内存就会被系统自动回收，不会产生内存泄漏问题
堆内存：由应用程序自己来分配和管理，容易产生内存泄漏
只读段：包括程序的代码和常量，由于是只读的，不会产生内存泄漏
数据段：包括全局变量和静态变量，不会产生内存泄漏
内存映射段：包括动态链接库和共享内存，其中共享内存由程序动态分配和管理，可能产生内存泄漏

+ 系统最终可以通过OOM机制杀死进程

### 案例分析

+ 通过vmstat 观察free列的变化情况，如果free在逐渐的减小，而buffer和cache基本不变，说明系统中使用的内存一直在升高
+ 通过memleak命令可以跟踪系统或指定金成功的内存分配和释放请求，然后定期输出一个未释放内存和相应调用栈的汇总情况，查找到对应的进程函数之后，对应修改即可
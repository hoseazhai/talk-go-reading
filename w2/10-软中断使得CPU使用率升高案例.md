## 10 | 案例篇：系统的软中断CPU使用率升高，我该怎么办？

## 案例分析

### 现象
链接中断命令变慢，ping的话出现丢包现象

## 案例分析步骤
1. 首先使用top查看系统的资源使用情况，发现CPU使用率都不高，但是基本都用在了软中断上，CPU使用率最高的也是软中断的相关进程
2. 通过/proc/softirq文件系统查看相应的中断次数，通过watch来查看对应中断的变化速率，发现网络接收包中断的速率最快
3. 使用sar命令查看系统的网络收发情况

```sh

# -n DEV 表示显示网络收发的报告，间隔1秒输出一组数据
$ sar -n DEV 1
15:03:46        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s   %ifutil
15:03:47         eth0  12607.00   6304.00    664.86    358.11      0.00      0.00      0.00      0.01
15:03:47      docker0   6302.00  12604.00    270.79    664.66      0.00      0.00      0.00      0.00
15:03:47           lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00      0.00
15:03:47    veth9f6bbcd   6302.00  12604.00    356.95    664.66      0.00      0.00      0.00      0.05
```
第一列：报告时间
第二列：网卡
三四列：rxpck/s 和 txpck/s 分别表示每秒接收、发送的网络帧数，也就是 PPS
五六列：rxkB/s 和 txkB/s 分别表示每秒接收、发送的千字节数，也就是 BPS

4. 通过观察发现在eth0上的PPS比较大，而接收的BPS比较小，通过计算664*1024/12607=54字节，说明 平均网络帧只有54字节，这显然是很小的网络帧。
5.通过tcpdump抓包工具进行抓包

```sh

# -i eth0 只抓取eth0网卡，-n不解析协议名和主机名
# tcp port 80表示只抓取tcp协议并且端口号为80的网络帧
$ tcpdump -i eth0 -n tcp port 80
15:11:32.678966 IP 192.168.0.2.18238 > 192.168.0.30.80: Flags [S], seq 458303614, win 512, length 0
...
```
发现这是一个SYN包

6.至此，全部分析完成，在防火墙上禁掉相应的IP即可


